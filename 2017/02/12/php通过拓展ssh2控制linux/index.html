<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title> php通过拓展ssh2控制linux | Qiaochy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="注意：我们用PHP来控制Linux，PHP环境可以在windows也可以在Linux，但是我们要控制的机器是一台linux（被控制的linux关闭selinux和firewalld）。如果php在linux，不会安装没关系，可以参考安装lamp教程地址：  http://blog.csdn.NET/zph1234/article/details/51248124然后我们的php环境要想实现控制li">
<meta property="og:type" content="article">
<meta property="og:title" content=" php通过拓展ssh2控制linux">
<meta property="og:url" content="http://yoursite.com/2017/02/12/php通过拓展ssh2控制linux/index.html">
<meta property="og:site_name" content="Qiaochy">
<meta property="og:description" content="注意：我们用PHP来控制Linux，PHP环境可以在windows也可以在Linux，但是我们要控制的机器是一台linux（被控制的linux关闭selinux和firewalld）。如果php在linux，不会安装没关系，可以参考安装lamp教程地址：  http://blog.csdn.NET/zph1234/article/details/51248124然后我们的php环境要想实现控制li">
<meta property="og:updated_time" content="2017-02-12T11:57:48.209Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content=" php通过拓展ssh2控制linux">
<meta name="twitter:description" content="注意：我们用PHP来控制Linux，PHP环境可以在windows也可以在Linux，但是我们要控制的机器是一台linux（被控制的linux关闭selinux和firewalld）。如果php在linux，不会安装没关系，可以参考安装lamp教程地址：  http://blog.csdn.NET/zph1234/article/details/51248124然后我们的php环境要想实现控制li">
  
    <link rel="alternate" href="/atom.xml" title="Qiaochy" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Qiaochy</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-php通过拓展ssh2控制linux" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/12/php通过拓展ssh2控制linux/" class="article-date">
  <time datetime="2017-02-12T11:56:56.000Z" itemprop="datePublished">2017-02-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
       php通过拓展ssh2控制linux
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>注意：我们用PHP来控制Linux，PHP环境可以在windows也可以在Linux，但是我们要控制的机器是一台linux（被控制的linux关闭selinux和firewalld）。<br>如果php在linux，不会安装没关系，可以参考安装lamp教程地址：  <a href="http://blog.csdn.NET/zph1234/article/details/51248124" target="_blank" rel="external">http://blog.csdn.NET/zph1234/article/details/51248124</a><br>然后我们的php环境要想实现控制linux，必须安装php的一个扩展ssh2<br>0.下载ssh2扩展，从<a href="http://pecl.php.net/package/ssh2，有linux扩展包，也有windows的dll，如果是php5安装ssh2-0.13或0.12扩展,php7安装1.0" target="_blank" rel="external">http://pecl.php.net/package/ssh2，有linux扩展包，也有windows的dll，如果是php5安装ssh2-0.13或0.12扩展,php7安装1.0</a><br>1.windows中的php安装扩展，需要下载dll文件，在php.ini中引入即可<br>2.这里是centos中的php安装ssh2扩展，记得关闭selinux和firewalld<br>yum install libssh2 libssh2-devel php-devel gcc-c++<br>3.如果是php5安装ssh2-0.13扩展,php7安装1.0<br>cd ssh2-0.13/<br>/usr/bin/phpize<br>./configure –with-php-config=/usr/bin/php-config LIBS=-ldl<br>make<br>make install</p>
<ol>
<li>vi /etc/php.ini<br>加入extension=ssh2.so<br>5.重启apache<br>6.vi test.php<br>[php] view plain copy  在CODE上查看代码片派生到我的代码片<br>&lt;?php  </li>
</ol>
<p>$host=’127.0.0.1’;//被控制的linux的ip  </p>
<p>$user=’root’;//用户名  </p>
<p>$passwd=’123456’;//密码  </p>
<p>// 链接远程服务器  </p>
<p>$connection = ssh2_connect($host, 22);  </p>
<p>if (!$connection) die(‘connection to ‘.$host.’:22 failed’);  </p>
<p>echo ‘connection OK<br>‘;  </p>
<p>// 获取验证方式并打印  </p>
<p>$auth_methods = ssh2_auth_none($connection, $user);  </p>
<p>print_r( $auth_methods.’<br>‘);  </p>
<p>if (in_array(‘password’, $auth_methods ))<br>{  </p>
<pre><code>// 通过password方式登录远程服务器  

if (ssh2_auth_password($connection, $user, $passwd))  

{  

    echo $user.&apos; login OK&lt;br/&gt;&apos;;  

    $stream = ssh2_exec($connection, &quot;pwd&quot;); // 执行php  

    stream_set_blocking($stream, true); // 获取执行pwd后的内容  

     if ($stream === FALSE) die(&quot;pwd failed&quot;);  

    echo &apos;pwd: &apos;.stream_get_contents($stream).&apos;&lt;br/&gt;&apos;;  

}  

else  

{  

    die( $user.&apos; login Failed&lt;br/&gt;&apos;);  

}  
</code></pre><p>}<br>上面只是测试，下面是控制mysql服务开启关闭的代码部分<br>c.php<br>&lt;?php<br>header(“content-type:text/html;charset=utf8”);<br>$str=”systemctl status mysql.service “;<br>//$str=”pwd”;<br>$host=’<strong><strong>*</strong></strong>‘;//被控制的linux的ip<br>$user=’<strong>*</strong>‘;//用户名<br>$passwd=’<strong>**</strong>‘;//密码<br>// 链接远程服务器<br>$connection = ssh2_connect($host, 22);<br>/<em>if (!$connection) die(‘connection to ‘.$host.’:22 failed’);<br>echo ‘connection OK<br>‘;</em>/<br>// 获取验证方式并打印<br>$auth_methods = ssh2_auth_none($connection, $user);<br>if (in_array(‘password’, $auth_methods ))<br>{<br>    // 通过password方式登录远程服务器<br>    if (ssh2_auth_password($connection, $user, $passwd))<br>    {<br>        /<em>echo $user.’ login OK<br>‘;</em>/<br>        $stream = ssh2_exec($connection, $str); // 执行php<br>        $pwd=stream_set_blocking($stream, true);<br>//        var_dump($pwd);<br>        // 获取执行pwd后的内容<br>        $pwd1=stream_get_contents($stream);<br>//        print_r($pwd1);<br>        $a=strpos($pwd1,’running’);<br>//        var_dump($a);<br>        if($a)<br>        {<br>            $b=’running’;<br>            $st=”systemctl stop mysql.service”;<br>        }else<br>        {<br>            $b=’dead’;<br>            $st=”systemctl start mysql.service”;<br>        }<br>//        $stream = ssh2_exec($connection, $st); // 执行php<br>        /<em> $pwd=stream_set_blocking($stream, true); // 获取执行pwd后的内容<br>         if ($stream === FALSE) die(“pwd failed”);<br>         echo ‘pwd: ‘.stream_get_contents($stream).’<br>‘;</em>/<br>    }<br>    else<br>    {<br>        die( $user.’ login Failed<br>‘);<br>    }<br>}</p>
<p>?&gt;<br>&lt;!doctype html&gt;</p>
<p><html lang="en"></html></p>
<p><head><br>    <meta charset="UTF-8"><br>    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"><br>    <meta http-equiv="X-UA-Compatible" content="ie=edge"><br>    <title>Document</title><br></head></p>
<p><body></body></p>
<p><table border="1"><br>    <tr><br>        <td>主机昵称</td><br>        <td>ip地址</td><br>        <td>mysql服务状态</td><br>        <td>操作</td><br>    </tr><br>    <tr><br>        <td>我的阿里云</td><br>        <td><strong><strong>**</strong></strong></td><br>        <td>&lt;?=$b?&gt;</td><br>        <td><br>            &lt;?php if($b==’dead’){?&gt;<br>                <a href="d.php?st=<?=$st?>">开启</a><br>            &lt;?php }else{?&gt;<br>                <a href="d.php?st=<?=$st?>">关闭</a><br>            &lt;?php }?&gt;<br>        </td><br>    </tr><br></table><br><br><br>d.php<br>&lt;?php<br>header(“content-type:text/html;charset=utf8”);<br>$st=$_GET[‘st’];<br>$str=”systemctl status mysql.service “;<br>//$str=”pwd”;<br>$host=’127.0.0.1’;//被控制的linux的ip<br>$user=’root’;//用户名<br>$passwd=’Xg10086212!@#’;//密码<br>// 链接远程服务器<br>$connection = ssh2_connect($host, 22);<br>$auth_methods = ssh2_auth_none($connection, $user);<br>if (in_array(‘password’, $auth_methods ))<br>{<br>    // 通过password方式登录远程服务器<br>    if (ssh2_auth_password($connection, $user, $passwd))<br>    {<br>        /<em>echo $user.’ login OK<br>‘;</em>/<br>        $stream = ssh2_exec($connection, $str); // 执行php<br>        $pwd=stream_set_blocking($stream, true);<br>//        var_dump($pwd);<br>        // 获取执行pwd后的内容<br>        $pwd1=stream_get_contents($stream);<br>//        print_r($pwd1);</p>
<pre><code>    $stream = ssh2_exec($connection, $st); // 执行php
    /* $pwd=stream_set_blocking($stream, true); // 获取执行pwd后的内容
     if ($stream === FALSE) die(&quot;pwd failed&quot;);
     echo &apos;pwd: &apos;.stream_get_contents($stream).&apos;&lt;br/&gt;&apos;;*/
}
else
{
    die( $user.&apos; login Failed&lt;br/&gt;&apos;);
}
</code></pre><p>}</p>
<p>$stream = ssh2_exec($connection, $st); // 执行php<br>header(“Location:c.php”);</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/02/12/php通过拓展ssh2控制linux/" data-id="ciz2nsr3j0004snmq6l3u3bff" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/02/12/curl模拟/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          curl模拟
        
      </div>
    </a>
  
  
    <a href="/2017/02/11/CentOS-7安装Etherpad-在线协作编辑/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CentOS 7安装Etherpad(在线协作编辑)</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/12/linux安装memcache以及分布式缓存/">linux安装memcache以及分布式缓存</a>
          </li>
        
          <li>
            <a href="/2017/02/12/curl模拟/">curl模拟</a>
          </li>
        
          <li>
            <a href="/2017/02/12/php通过拓展ssh2控制linux/"> php通过拓展ssh2控制linux</a>
          </li>
        
          <li>
            <a href="/2017/02/11/CentOS-7安装Etherpad-在线协作编辑/">CentOS 7安装Etherpad(在线协作编辑)</a>
          </li>
        
          <li>
            <a href="/2017/02/11/我的blog/">我的blog</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>